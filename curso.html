<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Curso</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { 
  getFirestore, doc, getDoc, setDoc, updateDoc 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ---------- Firebase Config ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyC4AAbC8vCFAmlPlur12Nm7YBKPjaSjumM",
  authDomain: "meuappweb-65522.firebaseapp.com",
  projectId: "meuappweb-65522",
  storageBucket: "meuappweb-65522.firebasestorage.app",
  messagingSenderId: "305368794616",
  appId: "1:305368794616:web:d987589863479e576ac20d",
  measurementId: "G-L0VWMGJ003"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ---------- Captura do ID do curso pela URL ---------- */
const params = new URLSearchParams(window.location.search);
const cursoId = params.get("id");

if (!cursoId) {
  alert("Curso inválido ou não encontrado.");
  window.location.href = "painel.html";
}

/* ---------- Variáveis globais ---------- */
const totalAulas = 20;
const primeiroSlideAula = 3;
const ultimoSlide = primeiroSlideAula + totalAulas - 1;
let uid = null;
let alunoCursoRef = null;
let alunoNome = "";

/* ---------- Autenticação ---------- */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  uid = user.uid;
  document.getElementById("usuario-email").textContent = user.email;

  // Buscar dados do aluno
  const alunoRef = doc(db, "alunos", uid);
  const alunoSnap = await getDoc(alunoRef);
  if (alunoSnap.exists()) {
    alunoNome = alunoSnap.data().nome || "Aluno";
    document.getElementById("nome-aluno").textContent = alunoNome;
  }

  // Referência do curso específico
  alunoCursoRef = doc(db, "alunos", uid, "cursos", cursoId);
  const cursoSnap = await getDoc(alunoCursoRef);
  if (!cursoSnap.exists()) {
    await setDoc(alunoCursoRef, {
      cursoId: cursoId,
      aulaAtual: 0,
      progresso: 0,
      dataMatricula: new Date().toLocaleDateString("pt-BR"),
    });
  }

  mostrarSlide(1);
  atualizarListaDeAulas();
});

/* ---------- Controle de slides ---------- */
let slideAtual = 1;
function mostrarSlide(n) {
  for (let i = 1; i <= ultimoSlide; i++) {
    const el = document.getElementById("slide" + i);
    if (el) el.style.display = (i === n) ? "block" : "none";
  }
  slideAtual = n;
}

/* ---------- Funções principais ---------- */
window.iniciarCurso = () => mostrarSlide(2);

async function obterProgresso() {
  const snap = await getDoc(alunoCursoRef);
  return snap.exists() ? snap.data() : { aulaAtual: 0, progresso: 0 };
}

async function atualizarListaDeAulas() {
  const { aulaAtual, progresso } = await obterProgresso();
  const lista = document.getElementById("lista-aulas");
  lista.innerHTML = "";

  for (let i = 1; i <= totalAulas; i++) {
    const btn = document.createElement("button");
    btn.className = "btn-aula";
    btn.textContent = `Aula ${i}`;
    btn.disabled = i > aulaAtual + 1;
    btn.onclick = () => mostrarSlide(primeiroSlideAula + (i - 1));

    if (i <= aulaAtual) {
      btn.classList.add("concluida");
      btn.textContent += " ✓";
    }

    lista.appendChild(btn);
  }

  document.getElementById("progresso-text").textContent = progresso + "%";
  document.getElementById("progresso-bar").style.width = progresso + "%";
}

window.finalizarAula = async (numAula) => {
  const { aulaAtual } = await obterProgresso();

  if (numAula !== aulaAtual + 1 && numAula !== aulaAtual) {
    alert("Finalize as aulas anteriores primeiro!");
    return;
  }

  const novaAulaAtual = Math.max(numAula, aulaAtual);
  const novoProgresso = Math.round((novaAulaAtual / totalAulas) * 100);

  await updateDoc(alunoCursoRef, {
    aulaAtual: novaAulaAtual,
    progresso: novoProgresso,
    atualizadoEm: new Date().toLocaleString()
  });

  alert(`Aula ${numAula} concluída! Seu progresso agora é ${novoProgresso}%.`);
  atualizarListaDeAulas();
  mostrarSlide(2);
};

window.sair = async () => {
  await signOut(auth);
  window.location.href = "login.html";
};
</script>

<style>
body { font-family: Arial, sans-serif; background: #f4f6f9; margin: 0; padding: 20px; }
.slide { display: none; background: white; max-width: 800px; margin: auto; padding: 25px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
h1, h2 { color: #007bff; }
.btn { background: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; }
.btn:hover { background: #0056b3; }
.btn-ghost { background: transparent; border: 1px solid #ccc; padding: 8px 12px; border-radius: 8px; cursor: pointer; }
.btn-aula { display: inline-block; margin: 5px; padding: 10px 15px; border-radius: 8px; border: 1px solid #ccc; background: white; cursor: pointer; }
.btn-aula:disabled { background: #eee; cursor: not-allowed; }
.btn-aula.concluida { background: #28a745; color: white; }
.progresso-wrap { background: #e9ecef; height: 12px; border-radius: 8px; overflow: hidden; margin-top: 10px; }
.progresso-bar { background: #28a745; height: 100%; width: 0%; transition: width .4s; }
footer { text-align: center; color: #666; margin-top: 20px; }
</style>
</head>

<body>
<div style="max-width:800px;margin:auto;display:flex;justify-content:space-between;align-items:center;">
  <span id="usuario-email"></span>
  <button class="btn-ghost" onclick="sair()">Sair</button>
</div>

<!-- SLIDE 1 - Apresentação -->
<div id="slide1" class="slide">
  <h1>Apresentação do Curso</h1>
  <p>Bem-vindo, <strong id="nome-aluno"></strong>!</p>
  <p>Este é o início do curso que você escolheu. Clique abaixo para começar.</p>
  <button class="btn" onclick="iniciarCurso()">Acessar Curso</button>
</div>

<!-- SLIDE 2 - Lista de Aulas -->
<div id="slide2" class="slide">
  <h2>Lista de Aulas</h2>
  <p>Conclua cada aula para desbloquear a próxima.</p>
  <div id="lista-aulas"></div>

  <div style="margin-top:20px;">
    <p>Progresso atual: <span id="progresso-text">0%</span></p>
    <div class="progresso-wrap">
      <div id="progresso-bar" class="progresso-bar"></div>
    </div>
  </div>

  <button class="btn-ghost" onclick="mostrarSlide(1)" style="margin-top:20px;">Voltar à apresentação</button>
</div>

<!-- SLIDES DAS AULAS -->
<script>
  const totalAulas = 20;
  const primeiroSlideAula = 3;

  for (let i = 1; i <= totalAulas; i++) {
    const slide = document.createElement("div");
    slide.id = "slide" + (primeiroSlideAula + i - 1);
    slide.className = "slide";
    slide.innerHTML = `
      <h2>Aula ${i}</h2>
      <p>Conteúdo da Aula ${i} — insira aqui vídeos, textos ou atividades.</p>
      <button class="btn" onclick="finalizarAula(${i})">Finalizar Aula ${i}</button>
      <button class="btn-ghost" onclick="mostrarSlide(2)">Voltar à Lista de Aulas</button>
    `;
    document.body.appendChild(slide);
  }
</script>

<footer>
  Seu progresso será salvo automaticamente no painel do aluno.
</footer>
</body>
</html>
