<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Painel do Aluno</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyC4AAbC8vCFAmlPlur12Nm7YBKPjaSjumM",
  authDomain: "meuappweb-65522.firebaseapp.com",
  projectId: "meuappweb-65522",
  storageBucket: "meuappweb-65522.firebasestorage.app",
  messagingSenderId: "305368794616",
  appId: "1:305368794616:web:d987589863479e576ac20d",
  measurementId: "G-L0VWMGJ003"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* Variáveis globais */
let uid = null;
let alunoNome = "";

/* Autenticação */
onAuthStateChanged(auth, async (user) => {
  if (!user) window.location.href = "login.html";

  uid = user.uid;
  document.getElementById("usuario-email").textContent = user.email;

  const alunoSnap = await getDoc(doc(db, "alunos", uid));
  alunoNome = alunoSnap.exists() ? alunoSnap.data().nome : "Aluno";
  document.getElementById("nome-aluno").textContent = alunoNome;

  carregarCursos();
});

/* Carregar cursos */
async function carregarCursos() {
  const container = document.getElementById("cursos-container");
  container.innerHTML = "<p>Carregando cursos...</p>";

  const cursosSnap = await getDocs(collection(db, "cursos"));
  container.innerHTML = "";

  for (const cursoDoc of cursosSnap.docs) {
    const curso = cursoDoc.data();
    const cursoId = cursoDoc.id;

    // Garantir que exista progresso para o aluno
    const alunoCursoRef = doc(db, "alunos", uid, "cursos", cursoId);
    const alunoCursoSnap = await getDoc(alunoCursoRef);
    if (!alunoCursoSnap.exists()) {
      await setDoc(alunoCursoRef, { aulaAtual: 0, progresso: 0, cursoId });
    }

    const progresso = alunoCursoSnap.exists() ? alunoCursoSnap.data().progresso || 0 : 0;

    const card = document.createElement("div");
    card.className = "card-curso";
    card.innerHTML = `
      <h3>${curso.nome}</h3>
      <p>${curso.descricao || "Sem descrição"}</p>
      <div class="progresso">
        <div class="progresso-bar" style="width:${progresso}%"></div>
      </div>
      <p>${progresso}% concluído</p>
      <button class="btn" onclick="entrarCurso('${curso.url}')">Acessar Curso</button>
    `;
    container.appendChild(card);
  }
}

/* Entrar no curso */
window.entrarCurso = (url) => {
  if (url) window.location.href = url;
  else alert("Este curso não tem URL cadastrada.");
};

/* Sair */
window.sair = async () => {
  await signOut(auth);
  window.location.href = "login.html";
};
</script>

<style>
body { font-family: Arial; background:#f4f6f9; margin:0; padding:20px; }
header { display:flex; justify-content:space-between; align-items:center; }
h2 { margin-top:20px; color:#007bff; }
#cursos-container { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:15px; margin-top:15px; }
.card-curso { background:white; padding:15px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
.card-curso h3 { margin:0;color:#007bff; }
.progresso { background:#eee;height:10px;border-radius:5px;overflow:hidden;margin:5px 0; }
.progresso-bar { height:100%; background:#28a745; transition: width 0.3s; }
.btn { padding:8px 12px; border:none; border-radius:5px; background:#007bff; color:white; cursor:pointer; }
.btn:hover { background:#0056b3; }
footer { text-align:center;margin-top:30px;color:#666; }
</style>
</head>

<body>
<header>
  <div>
    <strong>Bem-vindo(a), <span id="nome-aluno"></span></strong><br>
    <small id="usuario-email"></small>
  </div>
  <button class="btn" onclick="sair()">Sair</button>
</header>

<h2>Seus Cursos</h2>
<div id="cursos-container"></div>

<footer>
  Escolha um curso para começar ou continuar.
</footer>
</body>
</html>
