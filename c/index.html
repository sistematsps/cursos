<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Painel de Chat</title>
<style>
  *{box-sizing:border-box;font-family:Arial, sans-serif;}
  body{margin:0;background:#f4f4f4;}
  #loginOverlay{
    position:fixed;inset:0;background:#fff;display:flex;flex-direction:column;
    justify-content:center;align-items:center;gap:10px;z-index:10;
  }
  #loginOverlay input{padding:10px;width:250px;border:1px solid #ccc;border-radius:5px;}
  #loginOverlay button{padding:10px 20px;background:#007bff;color:#fff;border:none;border-radius:5px;cursor:pointer;}
  #loginOverlay p{color:red;margin:5px 0 0 0;}
  .card{
    display:none;
    height:100vh;
    flex-direction:row;
  }
  .sidebar{
    width:25%;
    background:#fff;
    border-right:1px solid #ddd;
    display:flex;
    flex-direction:column;
  }
  .chatArea{
    flex:1;
    display:flex;
    flex-direction:column;
  }
  .chatMessages{
    flex:1;
    overflow-y:auto;
    padding:10px;
  }
  .chatInput{
    display:flex;
    border-top:1px solid #ccc;
  }
  .chatInput input{
    flex:1;
    padding:10px;
    border:none;
    outline:none;
  }
  .chatInput button{
    padding:10px 20px;
    border:none;
    background:#007bff;
    color:#fff;
  }
  .contact{
    padding:10px;
    border-bottom:1px solid #eee;
    cursor:pointer;
  }
  .contact:hover{
    background:#f1f1f1;
  }
  #logoutBtn{
    background:#dc3545;
    color:white;
    border:none;
    padding:8px;
    margin:10px;
    border-radius:5px;
    cursor:pointer;
  }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginOverlay">
  <h2>Entrar no Sistema</h2>
  <input type="email" id="loginEmail" placeholder="E-mail" />
  <input type="password" id="loginPassword" placeholder="Senha" />
  <button id="loginBtn">Entrar</button>
  <p id="loginMsg"></p>
</div>

<!-- APP -->
<div class="card">
  <div class="sidebar">
    <h3 style="text-align:center;">Contatos</h3>
    <input type="text" id="searchUser" placeholder="Buscar contato..." style="margin:10px;padding:8px;width:calc(100% - 20px);" />
    <div id="contactsList"></div>
    <button id="logoutBtn">Sair</button>
  </div>

  <div class="chatArea">
    <div class="chatMessages" id="chatMessages"></div>
    <div class="chatInput">
      <input type="text" id="messageInput" placeholder="Digite sua mensagem..." />
      <button id="sendBtn">Enviar</button>
    </div>
  </div>
</div>

<!-- FIREBASE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, addDoc, query, where, getDocs, orderBy, onSnapshot, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "SUA_API_KEY",
    authDomain: "SEU_DOMINIO.firebaseapp.com",
    projectId: "SEU_PROJECT_ID",
    storageBucket: "SEU_PROJECT_ID.appspot.com",
    messagingSenderId: "SEU_SENDER_ID",
    appId: "SEU_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const loginOverlay = document.getElementById('loginOverlay');
  const loginEmail = document.getElementById('loginEmail');
  const loginPassword = document.getElementById('loginPassword');
  const loginBtn = document.getElementById('loginBtn');
  const loginMsg = document.getElementById('loginMsg');
  const logoutBtn = document.getElementById('logoutBtn');
  const contactsList = document.getElementById('contactsList');
  const searchUser = document.getElementById('searchUser');
  const chatMessages = document.getElementById('chatMessages');
  const sendBtn = document.getElementById('sendBtn');
  const messageInput = document.getElementById('messageInput');

  let currentUser = null;
  let currentChatUser = null;

  // LOGIN
  loginBtn.onclick = async ()=>{
    loginMsg.textContent='';
    loginBtn.disabled=true;
    const email = loginEmail.value.trim();
    const senha = loginPassword.value;
    if(!email || !senha){
      loginMsg.textContent='Digite e-mail e senha';
      loginBtn.disabled=false;
      return;
    }

    try {
      await signInWithEmailAndPassword(auth, email, senha);
      loginEmail.value='';
      loginPassword.value='';
    } catch(err) {
      console.error(err);
      loginMsg.textContent = 'E-mail ou senha incorretos.';
    }
    loginBtn.disabled=false;
  };

  logoutBtn.onclick = async ()=>{ await signOut(auth); };

  onAuthStateChanged(auth, async user=>{
    if(user){
      currentUser = user;
      loginOverlay.style.display='none';
      document.querySelector('.card').style.display='flex';
      loadContacts();
    } else {
      loginOverlay.style.display='flex';
      document.querySelector('.card').style.display='none';
    }
  });

  // CARREGAR CONTATOS (somente com quem jÃ¡ teve conversa)
  async function loadContacts(){
    contactsList.innerHTML = '';
    const q = query(collection(db, "mensagens"), where("participantes", "array-contains", currentUser.uid));
    const snap = await getDocs(q);

    const contatos = new Set();
    snap.forEach(doc=>{
      const data = doc.data();
      data.participantes.forEach(uid=>{
        if(uid !== currentUser.uid) contatos.add(uid);
      });
    });

    for(let uid of contatos){
      const userDoc = await getDoc(doc(db, "users", uid));
      if(userDoc.exists()){
        const div = document.createElement('div');
        div.className='contact';
        div.textContent = userDoc.data().nome || userDoc.data().email;
        div.onclick=()=>openChat(uid, div.textContent);
        contactsList.appendChild(div);
      }
    }
  }

  // PESQUISA DE NOVO CONTATO
  searchUser.oninput = async ()=>{
    const term = searchUser.value.trim().toLowerCase();
    contactsList.innerHTML = '';
    if(term.length < 2) { loadContacts(); return; }

    const q = query(collection(db,"users"));
    const snap = await getDocs(q);
    snap.forEach(doc=>{
      const data = doc.data();
      if(data.email.toLowerCase().includes(term) || (data.nome && data.nome.toLowerCase().includes(term))){
        const div = document.createElement('div');
        div.className='contact';
        div.textContent = data.nome || data.email;
        div.onclick=()=>openChat(doc.id, div.textContent);
        contactsList.appendChild(div);
      }
    });
  };

  // ABRIR CHAT
  function openChat(uid, nome){
    currentChatUser
