<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mini WhatsApp com Foto de Perfil</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #ece5dd;
      margin: 0;
      padding: 0;
      display: flex;
      height: 100vh;
      justify-content: center;
      align-items: center;
    }
    #login-screen, #register-screen, #chat-screen {
      display: none;
      width: 100%;
      max-width: 400px;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    form {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 5px #aaa;
      width: 90%;
      text-align: center;
    }
    input {
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    button {
      background: #25d366;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover {
      background: #128c7e;
    }
    .link {
      margin-top: 10px;
      color: #007bff;
      cursor: pointer;
    }
    .chat-container {
      display: flex;
      height: 100vh;
      width: 100%;
    }
    #contacts {
      width: 30%;
      background: #fff;
      overflow-y: auto;
      border-right: 1px solid #ccc;
    }
    .contact {
      display: flex;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    .contact:hover {
      background: #f9f9f9;
    }
    .contact img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
      object-fit: cover;
    }
    #chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #e5ddd5;
      position: relative;
    }
    #chat-header {
      background: #075e54;
      color: white;
      padding: 10px 15px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #chat-header img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #fff;
    }
    #messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
    }
    .message {
      padding: 8px 12px;
      margin: 5px;
      border-radius: 10px;
      max-width: 60%;
      clear: both;
    }
    .sent {
      background: #dcf8c6;
      margin-left: auto;
    }
    .received {
      background: #fff;
      margin-right: auto;
    }
    #input-area {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ccc;
      background: #f0f0f0;
    }
    #message-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
    }
    #send-btn {
      margin-left: 10px;
      background: #25d366;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 10px 20px;
      cursor: pointer;
    }
    #logout-btn {
      background: red;
      color: white;
      border: none;
      padding: 8px 15px;
      position: absolute;
      top: 10px;
      right: 10px;
      border-radius: 5px;
      cursor: pointer;
      z-index: 2;
    }
    #search-input {
      width: 90%;
      margin: 10px;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div id="login-screen" style="display:flex;">
    <form id="login-form">
      <h2>Entrar no Chat</h2>
      <input type="email" id="login-email" placeholder="E-mail" required />
      <input type="password" id="login-senha" placeholder="Senha" required />
      <button type="submit">Entrar</button>
      <div class="link" id="show-register">Cadastre-se</div>
    </form>
  </div>

  <!-- CADASTRO -->
  <div id="register-screen">
    <form id="register-form">
      <h2>Criar Conta</h2>
      <input type="text" id="register-nome" placeholder="Nome completo" required />
      <input type="email" id="register-email" placeholder="E-mail" required />
      <input type="password" id="register-senha" placeholder="Senha" required />
      <input type="file" id="register-foto" accept="image/*" required />
      <button type="submit">Cadastrar e Entrar</button>
      <div class="link" id="show-login">JÃ¡ tem conta? Entrar</div>
    </form>
  </div>

  <!-- CHAT -->
  <div id="chat-screen">
    <button id="logout-btn">Sair</button>
    <div class="chat-container">
      <div id="contacts">
        <input type="text" id="search-input" placeholder="Buscar contato..." />
        <div id="contacts-list"></div>
      </div>
      <div id="chat-area">
        <div id="chat-header">
          <img id="chat-header-photo" src="" alt="" style="display:none;">
          <span id="chat-header-name">Selecione um contato</span>
        </div>
        <div id="messages"></div>
        <div id="input-area">
          <input type="text" id="message-input" placeholder="Digite sua mensagem..." />
          <button id="send-btn">Enviar</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
      signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, collection, getDocs,
      onSnapshot, arrayUnion, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import {
      getStorage, ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC0dUhymi72gkug-oo0-xqqBEtgvlIgvY0",
      authDomain: "cursos-6f950.firebaseapp.com",
      projectId: "cursos-6f950",
      storageBucket: "cursos-6f950.appspot.com",
      messagingSenderId: "146131122545",
      appId: "1:146131122545:web:043f8207f457ad5b7f5ed0"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const loginScreen = document.getElementById("login-screen");
    const registerScreen = document.getElementById("register-screen");
    const chatScreen = document.getElementById("chat-screen");
    const showRegister = document.getElementById("show-register");
    const showLogin = document.getElementById("show-login");
    const contactsList = document.getElementById("contacts-list");
    const chatHeaderPhoto = document.getElementById("chat-header-photo");
    const chatHeaderName = document.getElementById("chat-header-name");
    const messagesDiv = document.getElementById("messages");
    const msgInput = document.getElementById("message-input");
    const sendBtn = document.getElementById("send-btn");
    const logoutBtn = document.getElementById("logout-btn");

    let currentUser = null;
    let selectedContact = null;
    let selectedContactData = null;
    let unsubscribeMessages = null;

    showRegister.onclick = () => {
      loginScreen.style.display = "none";
      registerScreen.style.display = "flex";
    };
    showLogin.onclick = () => {
      registerScreen.style.display = "none";
      loginScreen.style.display = "flex";
    };

    // Cadastro com foto
    document.getElementById("register-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const nome = document.getElementById("register-nome").value;
      const email = document.getElementById("register-email").value;
      const senha = document.getElementById("register-senha").value;
      const foto = document.getElementById("register-foto").files[0];
      if (!foto) return alert("Selecione uma foto!");

      try {
        const cred = await createUserWithEmailAndPassword(auth, email, senha);
        const fotoRef = ref(storage, `profile_photos/${cred.user.uid}.jpg`);
        await uploadBytes(fotoRef, foto);
        const fotoURL = await getDownloadURL(fotoRef);
        await setDoc(doc(db, "users", cred.user.uid), { nome, email, fotoURL, createdAt: serverTimestamp() });
        alert("Conta criada com sucesso!");
      } catch (err) {
        alert("Erro: " + err.message);
      }
    });

    document.getElementById("login-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("login-email").value;
      const senha = document.getElementById("login-senha").value;
      try {
        await signInWithEmailAndPassword(auth, email, senha);
      } catch (err) {
        alert("Erro ao entrar: " + err.message);
      }
    });

    logoutBtn.onclick = () => signOut(auth);

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        loginScreen.style.display = "none";
        registerScreen.style.display = "none";
        chatScreen.style.display = "block";
        loadContacts();
      } else {
        chatScreen.style.display = "none";
        loginScreen.style.display = "flex";
      }
    });

    async function loadContacts() {
      contactsList.innerHTML = "";
      const usersSnap = await getDocs(collection(db, "users"));
      usersSnap.forEach(u => {
        const d = u.data();
        if (u.id !== currentUser.uid) {
          const div = document.createElement("div");
          div.classList.add("contact");
          const img = document.createElement("img");
          img.src = d.fotoURL || "https://via.placeholder.com/40";
          const span = document.createElement("span");
          span.textContent = d.nome;
          div.append(img, span);
          div.onclick = () => openChat(u.id, d);
          contactsList.appendChild(div);
        }
      });
    }

    async function openChat(contactId, contactData) {
      selectedContact = contactId;
      selectedContactData = contactData;
      chatHeaderName.textContent = contactData.nome;
      chatHeaderPhoto.src = contactData.fotoURL;
      chatHeaderPhoto.style.display = "block";
      messagesDiv.innerHTML = "";
      if (unsubscribeMessages) unsubscribeMessages();

      const chatId = [currentUser.uid, contactId].sort().join("_");
      const chatRef = doc(db, "chats", chatId);

      unsubscribeMessages = onSnapshot(chatRef, (snap) => {
        if (!snap.exists()) return;
        const data = snap.data();
        messagesDiv.innerHTML = "";
        (data.mensagens || []).forEach(msg => {
          const div = document.createElement("div");
          div.classList.add("message", msg.de === currentUser.uid ? "sent" : "received");
          div.textContent = msg.texto;
          messagesDiv.appendChild(div);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    }

    sendBtn.onclick = async () => {
      const texto = msgInput.value.trim();
      if (!texto || !selectedContact) return;
      const chatId = [currentUser.uid, selectedContact].sort().join("_");
      const chatRef = doc(db, "chats", chatId);
      await setDoc(chatRef, {
        mensagens: arrayUnion({ texto, de: currentUser.uid, para: selectedContact, timestamp: serverTimestamp() })
      }, { merge: true });
      msgInput.value = "";
    };
  </script>
</body>
</html>
